<html>
	<head>
		<title></title>
	</head>
	<body>
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<style>
			.chart {
				width: 300; 
				height: 300;
				float: left;
			}
		</style>
		<div>W5AUU-1</div>
		<div id="chart1" class="chart"></div>
		<div id="chart2" class="chart"></div>
		<div id="chart3" class="chart"></div>
		<script type="text/javascript">
			function fluctuate(val, maxFluctuation){
				if (maxFluctuation == 0) {
					return val;
				}
				else {
					var r = Math.random();
					var flux;

					if (maxFluctuation < 1) {
						flux = maxFluctuation;
					}
					else {
						flux = Math.floor(r * (maxFluctuation+1));
					}

					if ((r*100) % 2 == 0) {
						rtnValue = val - flux;
					}
					else {
						rtnValue = val + flux;
					}
					return rtnValue;
				}
			}
			
			var jsonData; // Declared here to it is accessible globally
			$.getJSON("https://sitebygeorge.com/RepeaterWarning/json.php", function(result){
				jsonData = result;
			});
			
			google.charts.load('current', {'packages':['gauge']});
			google.charts.setOnLoadCallback(drawCharts);
			
			var options = {
				battery : {
					width: 300, height: 300, minorTicks: 1,
					redFrom: 10, redTo: 11,
					yellowFrom:11, yellowTo: 12,
					greenFrom: 12, greenTo: 14,
					min: 10.0, max: 14.0
				},
				time : {
					width: 300, height: 300, minorTicks: 1,
					redFrom: 360, redTo: 420,
					yellowFrom:120, yellowTo: 360,
					min: 0, max: 420
				},
				power : {
					width: 300, height: 300, majorTicks: 1,
					redFrom: 0, redTo: 2,
					greenFrom: 2, greenTo: 4,
					min: 0, max: 10
				}
			};

			function drawCharts() {
				if (jsonData) { // Don't run this unless jsonData is defined (might still be loading)
					drawChart("Battery (v)", "chart1", options.battery, jsonData.repeaters.w5auu1.voltage, 0.2);
					drawChart("Time (min)", "chart2", options.time, jsonData.repeaters.w5auu1.lastReportedMinutesAgo, 0);
					drawChart("Grid power", "chart3", options.power, jsonData.repeaters.w5auu1.powerValueForCharts, 2);
				}
				else {
					setTimeout(function() { drawCharts(); }, 1000); // Try again in a second
				}
			}
			function drawChart(strLabel, strDivId, objOptions, intValue, intFluctuate) {
				var data = google.visualization.arrayToDataTable([
					['Label', 'Value'],[strLabel, 0]
				]);

				var chart = new google.visualization.Gauge(document.getElementById(strDivId));
				chart.draw(data, objOptions);

				setInterval(function() {
					var val = fluctuate(jsonData.repeaters.w5auu1.voltage, intFluctuate);
					data.setValue(0, 1, intValue);
					chart.draw(data, objOptions);
				}, 1000);
			}
		</script>
	</body>
</html>