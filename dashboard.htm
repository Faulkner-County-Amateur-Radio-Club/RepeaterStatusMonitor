<html>
	<head>
		<title></title>
	</head>
	<body>
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<link rel="preconnect" href="https://fonts.gstatic.com">
		<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap" rel="stylesheet">
		<style>
			body {
				background-color: rgb(32, 33, 36);
				color: #ffffff;
			}
			.chart {
				width: 200px; 
				height: 200px;
				float: left;
			}
			.title {
				transform: rotate(-90deg);
				font-family: 'Black Ops One';
				float: left;
				width: 200px;
			}
			.repeater {
				clear: both;
			}
		</style>
		<div class="repeater">
			<div class="title">W5AUU-1</div>
			<div id="chart1a" class="chart"></div>
			<div id="chart1b" class="chart"></div>
			<div id="chart1c" class="chart"></div>
		</div>
		<div class="repeater">
			<div class="title">W5AUU-2</div>
			<div id="chart2a" class="chart"></div>
			<div id="chart2b" class="chart"></div>
			<div id="chart2c" class="chart"></div>
		</div>
		<div class="repeater">
			<div class="title">W5AUU-3</div>
			<div id="chart3a" class="chart"></div>
			<div id="chart3b" class="chart"></div>
			<div id="chart3c" class="chart"></div>
		</div>
		<script type="text/javascript">
			function fluctuate(val, maxFluctuation){
				if (maxFluctuation == 0) {
					return val;
				}
				else {
					var r = Math.random();
					var flux;

					if (maxFluctuation < 1) {
						flux = maxFluctuation;
					}
					else {
						flux = Math.floor(r * (maxFluctuation+1));
					}

					if ((r*100) % 2 == 0) {
						rtnValue = val - flux;
					}
					else {
						rtnValue = val + flux;
					}
					return rtnValue;
				}
			}
			
			var jsonData; // Declared here to it is accessible globally
			$.getJSON("https://sitebygeorge.com/RepeaterWarning/json.php", function(result){
				jsonData = result;
			});
			
			google.charts.load('current', {'packages':['gauge']});
			google.charts.setOnLoadCallback(drawCharts);
			
			var options = {
				battery : {
					width: 200, height: 200, minorTicks: 1,
					redFrom: 10, redTo: 11,
					yellowFrom:11, yellowTo: 12,
					greenFrom: 12, greenTo: 14,
					min: 10.0, max: 14.0
				},
				time : {
					width: 200, height: 200, minorTicks: 1, majorTicks: 60,
					redFrom: 360, redTo: 420,
					yellowFrom:120, yellowTo: 360,
					greenFrom: 0, greenTo: 120,
					min: 0, max: 420
				},
				power : {
					width: 200, height: 200, majorTicks: 1,
					redFrom: 0, redTo: 20,
					greenFrom: 20, greenTo: 40,
					min: 0, max: 40
				}
			};

			function drawCharts() {
				if (jsonData) { // Don't run this unless jsonData is defined (might still be loading)
					drawChart("Battery (v)", "chart1a", options.battery, jsonData.repeaters.w5auu1.voltage, 0);
					drawChart("Time (min)", "chart1b", options.time, jsonData.repeaters.w5auu1.lastReportedMinutesAgo, 0);
					drawChart("Grid power", "chart1c", options.power, jsonData.repeaters.w5auu1.powerValueForCharts, 5);

					drawChart("Battery (v)", "chart2a", options.battery, jsonData.repeaters.w5auu2.voltage, 0);
					drawChart("Time (min)", "chart2b", options.time, jsonData.repeaters.w5auu2.lastReportedMinutesAgo, 0);
					drawChart("Grid power", "chart2c", options.power, jsonData.repeaters.w5auu2.powerValueForCharts, 5);
					
					drawChart("Battery (v)", "chart3a", options.battery, jsonData.repeaters.w5auu3.voltage, 0);
					drawChart("Time (min)", "chart3b", options.time, jsonData.repeaters.w5auu3.lastReportedMinutesAgo, 0);
					drawChart("Grid power", "chart3c", options.power, jsonData.repeaters.w5auu3.powerValueForCharts, 5);
				}
				else {
					setTimeout(function() { drawCharts(); }, 1000); // Try again in a second
				}
			}
			function drawChart(strLabel, strDivId, objOptions, intValue, intFluctuate) {
				var data = google.visualization.arrayToDataTable([
					['Label', 'Value'],[strLabel, 0]
				]);

				var chart = new google.visualization.Gauge(document.getElementById(strDivId));
				chart.draw(data, objOptions);

				setInterval(function() {
					var val = fluctuate(intValue, intFluctuate);
					data.setValue(0, 1, val);
					chart.draw(data, objOptions);
				}, Math.round(Math.random()*1000));
			}
		</script>
	</body>
</html>